
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnMe Client Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- This div will contain the entire application -->
    <div id="app-container">

        <!-- LOGIN VIEW (Default) -->
        <div id="login-view">
            <div class="min-h-screen flex items-center justify-center">
                <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-md">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Welcome to OnMe</h2>
                    <p class="text-center text-gray-500 mb-8">Sign in to your account</p>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors">Sign In</button>
                    </form>
                    <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
                    <p class="text-sm text-center text-gray-600 mt-6">
                        Don't have an account? <a href="#" id="show-signup" class="font-medium text-indigo-600 hover:text-indigo-500">Sign up</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- SIGNUP VIEW -->
        <div id="signup-view" class="hidden">
            <div class="min-h-screen flex items-center justify-center">
                <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-md">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Create Your OnMe Account</h2>
                    <p class="text-center text-gray-500 mb-8">Get started with your virtual try-on widget</p>
                    <form id="signup-form">
                        <div class="mb-4">
                            <label for="signup-company" class="block text-sm font-medium text-gray-700">Company Name</label>
                            <input type="text" id="signup-company" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-4">
                            <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-6">
                            <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="signup-password" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors">Create Account</button>
                    </form>
                    <p id="signup-error" class="text-red-500 text-sm text-center mt-4"></p>
                     <p class="text-sm text-center text-gray-600 mt-6">
                        Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Sign in</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- DASHBOARD VIEW (Authenticated) -->
        <div id="dashboard-view" class="hidden">
            <nav class="bg-white shadow-sm">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex">
                            <div class="flex-shrink-0 flex items-center text-2xl font-bold text-indigo-600">OnMe</div>
                        </div>
                        <div class="flex items-center">
                             <span id="user-email" class="text-sm text-gray-600 mr-4"></span>
                            <button id="logout-button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 text-sm transition-colors">Sign Out</button>
                        </div>
                    </div>
                </div>
            </nav>
            <div class="py-10">
                <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <h1 class="text-3xl font-bold leading-tight text-gray-900">Dashboard</h1>
                </header>
                <main>
                    <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 mt-8">
                        <!-- Integration Section -->
                        <div class="bg-white p-8 rounded-xl shadow-md mb-8">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Integration</h2>
                            <p class="text-gray-600 mb-6">To add the OnMe widget to your website, place the following two snippets of code into your HTML.</p>
                            
                            <h3 class="font-semibold text-gray-700 mb-2">1. Add this script tag before your closing `&lt;/body&gt;` tag:</h3>
                            <pre class="bg-gray-100 p-4 rounded-lg text-sm text-gray-800 overflow-x-auto"><code id="widget-script-tag"></code></pre>
                            
                            <h3 class="font-semibold text-gray-700 mt-6 mb-2">2. Add this div where you want the widget to appear on your product page:</h3>
                            <pre class="bg-gray-100 p-4 rounded-lg text-sm text-gray-800"><code>&lt;div id="onme-widget-root"&gt;&lt;/div&gt;</code></pre>
                        </div>

                        <!-- Analytics Section -->
                        <div class="bg-white p-8 rounded-xl shadow-md mb-8">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Analytics</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="bg-indigo-50 p-6 rounded-lg">
                                    <h4 class="text-sm font-medium text-indigo-800">Monthly Try-Ons</h4>
                                    <p id="monthly-tryons" class="text-4xl font-bold text-indigo-600 mt-2">Loading...</p>
                                </div>
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <h4 class="text-sm font-medium text-green-800">Your Current Plan</h4>
                                    <p id="current-plan" class="text-4xl font-bold text-green-600 mt-2">Loading...</p>
                                </div>
                                <div class="bg-gray-100 p-6 rounded-lg">
                                    <h4 class="text-sm font-medium text-gray-800">Client ID</h4>
                                    <p id="client-id-display" class="text-2xl font-mono text-gray-600 mt-3 break-all">Loading...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Billing Section -->
                        <div class="bg-white p-8 rounded-xl shadow-md">
                             <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Your Subscription</h2>
                             <div id="billing-error" class="text-red-500 text-sm mb-4"></div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                 <!-- Core Plan -->
                                 <div class="border border-gray-200 rounded-lg p-6 flex flex-col">
                                     <h3 class="text-xl font-semibold">OnMe Core</h3>
                                     <p class="text-gray-500 mt-2">The essential virtual try-on experience.</p>
                                     <p class="text-4xl font-bold my-4">$19<span class="text-base font-medium text-gray-500">/mo</span></p>
                                     <ul class="space-y-2 text-gray-600 mb-6 flex-grow">
                                         <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Basic Try-On Widget</li>
                                         <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Up to 1,000 try-ons/mo</li>
                                     </ul>
                                     <button data-price-id="price_1PuaTTRs1d9g4j5k9f9f9f9f" class="upgrade-button w-full bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700 transition-colors">Select Core Plan</button>
                                 </div>
                                 <!-- Vibe Plan -->
                                 <div class="border-2 border-indigo-500 rounded-lg p-6 flex flex-col relative">
                                     <div class="absolute top-0 -translate-y-1/2 bg-indigo-500 text-white text-xs font-bold px-3 py-1 rounded-full">MOST POPULAR</div>
                                     <h3 class="text-xl font-semibold">OnMe Vibe</h3>
                                     <p class="text-gray-500 mt-2">Drive engagement with our UGC engine.</p>
                                     <p class="text-4xl font-bold my-4">$49<span class="text-base font-medium text-gray-500">/mo</span></p>
                                     <ul class="space-y-2 text-gray-600 mb-6 flex-grow">
                                         <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Everything in Core, plus:</li>
                                         <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>The Vibe Studio</li>
                                         <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Unlimited try-ons</li>
                                     </ul>
                                     <button data-price-id="price_1PuaUuRs1d9g4j5k9f9f9f9f" class="upgrade-button w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors">Upgrade to Vibe</button>
                                 </div>
                             </div>
                        </div>

                    </div>
                </main>
            </div>
        </div>

    </div>

    <script type="module">
        // --- IMPORTANT: Replace with your Supabase project details ---
        const SUPABASE_URL = 'https://dhubrstfaothjnsdxwmo.supabase.co'; // Your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIJWTJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRodWJyc3RmYW90aGpuc2R4d21vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NTk5NjUsImV4cCI6MjA3MjAzNTk2NX0.46PoeHfIDixWgtWWr0xV33ItXnYNemcXyH_iFPBNEj8'; // Your Supabase Anon Key

        const appContainer = document.getElementById('app-container');

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            appContainer.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-md text-center">
                        <h2 class="text-2xl font-bold text-red-600 mb-4">Configuration Required</h2>
                        <p class="text-gray-700">
                            Please open the <code>client_dashboard.html</code> file and add your Supabase URL and Anon Key to the script section to activate this dashboard.
                        </p>
                    </div>
                </div>`;
        } else {
            const { createClient } = supabase;
            const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- Element References ---
            const loginView = document.getElementById('login-view');
            const signupView = document.getElementById('signup-view');
            const dashboardView = document.getElementById('dashboard-view');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const logoutButton = document.getElementById('logout-button');
            const showSignupLink = document.getElementById('show-signup');
            const showLoginLink = document.getElementById('show-login');
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error');
            const billingError = document.getElementById('billing-error');
            
            // --- View Management ---
            const showView = (viewId) => {
                loginView.classList.add('hidden');
                signupView.classList.add('hidden');
                dashboardView.classList.add('hidden');
                document.getElementById(viewId).classList.remove('hidden');
            };

            // --- Authentication Logic ---
            async function handleSignUp(event) {
                event.preventDefault();
                const company = document.getElementById('signup-company').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                signupError.textContent = '';
                const { data, error } = await dbClient.auth.signUp({ email, password });
                if (error) {
                    signupError.textContent = error.message;
                } else if (data.user) {
                    const { error: profileError } = await dbClient
                        .from('clients')
                        .insert([{ id: data.user.id, company_name: company }]);
                    if (profileError) {
                         signupError.textContent = `Account created, but failed to create profile: ${profileError.message}`;
                    } else {
                        alert('Sign up successful! Please check your email for a confirmation link.');
                        showView('login-view');
                    }
                }
            }

            async function handleSignIn(event) {
                event.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                loginError.textContent = '';
                const { error } = await dbClient.auth.signInWithPassword({ email, password });
                if (error) { loginError.textContent = error.message; }
            }

            async function handleSignOut() {
                await dbClient.auth.signOut();
            }

            async function loadDashboardData(userId, userPlan) {
                 const { data, error } = await dbClient
                    .from('clients')
                    .select('client_id, plan')
                    .eq('id', userId)
                    .single();
                if (error) { console.error('Error fetching client data:', error); return; }

                const plan = data.plan.charAt(0).toUpperCase() + data.plan.slice(1);
                document.getElementById('current-plan').textContent = plan;
                document.getElementById('client-id-display').textContent = data.client_id;
                document.getElementById('widget-script-tag').textContent = `<script src="https://cdn.onme.fit/widget.js" data-client-id="${data.client_id}" defer><\/script>`;

                // Update billing buttons based on current plan
                document.querySelectorAll('.upgrade-button').forEach(button => {
                    const buttonPlan = button.dataset.priceId.includes('Core') ? 'Core' : 'Vibe'; // This is a simplification. Use actual Price IDs.
                    if (plan.toLowerCase() === buttonPlan.toLowerCase()) {
                        button.textContent = 'Current Plan';
                        button.disabled = true;
                        button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        button.classList.add('bg-gray-400', 'cursor-not-allowed');
                    }
                });

                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
                const { count, error: countError } = await dbClient
                    .from('try_on_events')
                    .select('*', { count: 'exact', head: true })
                    .eq('client_id', data.client_id)
                    .gte('created_at', thirtyDaysAgo);
                document.getElementById('monthly-tryons').textContent = countError ? 'Error' : count;
            }

            // --- Billing Logic ---
            async function handleUpgradeClick(event) {
                const priceId = event.target.dataset.priceId;
                billingError.textContent = '';
                event.target.textContent = 'Redirecting...';
                event.target.disabled = true;

                try {
                    const { data: { session } } = await dbClient.auth.getSession();
                    if (!session) throw new Error("You must be logged in to upgrade.");

                    const { data, error } = await dbClient.functions.invoke('create-checkout-session', {
                        body: { priceId },
                    });

                    if (error) throw error;
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error("Could not create a checkout session.");
                    }
                } catch (error) {
                    billingError.textContent = error.message;
                    event.target.textContent = 'Upgrade';
                    event.target.disabled = false;
                }
            }

            // --- Main App Logic ---
            dbClient.auth.onAuthStateChange((event, session) => {
                if (session) {
                    document.getElementById('user-email').textContent = session.user.email;
                    showView('dashboard-view');
                    loadDashboardData(session.user.id);
                } else {
                    showView('login-view');
                }
            });
            
            // --- Event Listeners ---
            loginForm.addEventListener('submit', handleSignIn);
            signupForm.addEventListener('submit', handleSignUp);
            logoutButton.addEventListener('click', handleSignOut);
            showSignupLink.addEventListener('click', (e) => { e.preventDefault(); showView('signup-view'); });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showView('login-view'); });
            document.querySelectorAll('.upgrade-button').forEach(button => {
                button.addEventListener('click', handleUpgradeClick);
            });
        }
    </script>
</body>
</html>
