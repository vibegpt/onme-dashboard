(function() {
    // This function runs when the script is loaded.

    // --- Configuration ---
    const WIDGET_ROOT_ID = 'onme-widget-root';
    const PRODUCT_IMAGE_ID = 'product-image-for-tryon';
    const SESSION_STORAGE_KEY = 'onme-user-selfie';
    const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent';

    // --- IMPORTANT: These need to be configured for the widget to log analytics ---
    const SUPABASE_URL = 'https://dhubrstfaothjnsdxwmo.supabase.co'; // Your Supabase URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRodWJyc3RmYW90aGpuc2R4d21vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NTk5NjUsImV4cCI6MjA3MjAzNTk2NX0.46PoeHfIDixWgtWWr0xV33ItXnYNemcXyH_iFPBNEj8'; // Your Supabase Anon Key
    let dbClient = null;


    // --- Asset URLs ---
    const SCENES = [
        'https://images.pexels.com/photos/1638324/pexels-photo-1638324.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2',
        'https://images.pexels.com/photos/3769138/pexels-photo-3769138.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2',
        'https://images.pexels.com/photos/21014/pexels-photo.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2',
        'https://images.pexels.com/photos/247929/pexels-photo-247929.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2',
        'https://images.pexels.com/photos/931007/pexels-photo-931007.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2'
    ];
    const STICKERS = [
        'https://www.svgrepo.com/show/509939/sparkle.svg',
        'https://www.svgrepo.com/show/521692/flower.svg',
        'https://www.svgrepo.com/show/530438/camera.svg',
        'https://www.svgrepo.com/show/508930/fire.svg',
        'https://www.svgrepo.com/show/493540/heart-love.svg',
        'https://www.svgrepo.com/show/521876/planet.svg'
    ];

    // --- Helper function to find the client's unique ID ---
    function getClientId() {
        const scriptTag = document.querySelector('script[src*="widget.js"]');
        return scriptTag ? scriptTag.getAttribute('data-client-id') : null;
    }
    
    // --- Analytics Logging ---
    async function logTryOnEvent() {
        const clientId = getClientId();
        if (!clientId || !dbClient) return;

        try {
            const { error } = await dbClient.from('try_on_events').insert([{ client_id: clientId }]);
            if (error) {
                console.error('OnMe Analytics Error:', error.message);
            } else {
                console.log('OnMe event logged successfully.');
            }
        } catch (e) {
            console.error('OnMe Analytics Exception:', e.message);
        }
    }


    // --- 1. Inject CSS Styles ---
    function injectCSS() {
        const styles = `
            :root { --onme-primary: #4f46e5; }
            #onme-widget-container {
                max-width: 400px; margin: 2em auto; border: 1px solid #e2e8f0; border-radius: 1rem;
                font-family: 'Inter', sans-serif;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                padding: 1.5rem; background-color: #ffffff;
            }
            #onme-widget-container .spinner { border-top-color: var(--onme-primary); animation: onme-spin 1s linear infinite; }
            @keyframes onme-spin { to { transform: rotate(360deg); } }
            #onme-vibe-studio-modal {
                position: fixed; inset: 0; z-index: 50; display: none;
                align-items: center; justify-content: center; padding: 1rem;
                background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            }
            #onme-vibe-studio-modal.flex { display: flex; }
            #onme-vibe-studio-modal .vibe-tab.active { border-color: var(--onme-primary); color: var(--onme-primary); }
            .onme-frame-polaroid { border: 15px solid white; border-bottom-width: 60px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); filter: sepia(0.2) saturate(1.2); }
            .onme-frame-neon { border: 5px solid #f0f; box-shadow: 0 0 10px #f0f, 0 0 20px #f0f; }
            .onme-frame-film { border: 20px solid #000; border-image: repeating-linear-gradient(0deg, #000, #000 10px, #fff 10px, #fff 12px, #000 12px, #000 20px) 20; filter: grayscale(0.5) contrast(1.1); }
            .onme-sticker { position: absolute; cursor: move; user-select: none; width: 60px; height: auto; transition: transform 0.1s; }
            .onme-sticker.dragging { transform: scale(1.1); box-shadow: 0 0 15px rgba(0,0,0,0.3); }
        `;
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = styles;
        document.head.appendChild(styleSheet);

        const fontLink = document.createElement('link');
        fontLink.href = "https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap";
        fontLink.rel = "stylesheet";
        document.head.appendChild(fontLink);
    }

    // --- 2. Create Widget HTML ---
    function createWidgetHTML(rootElement) {
        rootElement.innerHTML = `
            <h3 class="text-xl font-bold text-center text-gray-800 mb-1">Virtual Try-On</h3>
            <p class="text-sm text-gray-500 text-center mb-4">Upload your photo to see how this looks on you!</p>
            <div class="text-center mb-4">
                <img id="onme-person-preview" src="https://placehold.co/300x400/EFEFEF/333333?text=Your+Photo" alt="User photo preview" class="w-full max-w-[200px] mx-auto aspect-[3/4] object-cover rounded-lg bg-gray-100 shadow-inner">
                <label for="onme-person-upload" id="onme-upload-label" class="cursor-pointer text-sm font-semibold text-indigo-600 hover:text-indigo-800 mt-2 inline-block">Upload Your Photo</label>
                <input type="file" id="onme-person-upload" class="hidden" accept="image/*">
            </div>
            <div class="flex flex-col items-center">
                <button id="onme-generate-button" class="w-full text-center bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm disabled:bg-indigo-300" disabled>Generate Try-On</button>
                <div id="onme-loading-spinner" class="spinner w-8 h-8 rounded-full border-4 border-gray-300 hidden my-2"></div>
                <button id="onme-vibe-studio-button" class="w-full text-center bg-gray-700 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-gray-800 transition-colors shadow-sm hidden mt-2">Customize Your Vibe</button>
                <p id="onme-message" class="text-xs text-gray-500 mt-2 h-auto text-center"></p>
            </div>
        `;
        
        const modalHTML = `
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg max-h-full overflow-y-auto">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Vibe Studio</h2><button id="onme-modal-close-button" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div>
                <div id="onme-modal-result-container" class="relative w-full max-w-sm mx-auto aspect-[3/4] bg-gray-200 rounded-xl overflow-hidden shadow-inner flex items-center justify-center bg-cover bg-center">
                    <img id="onme-modal-result-image" alt="Generated image" class="absolute inset-0 w-full h-full object-contain">
                    <div id="onme-modal-sticker-container" class="absolute inset-0 w-full h-full"></div>
                </div>
                <div class="flex justify-center border-b my-4">
                    <button data-tab="scenes" class="vibe-tab active flex-1 py-2 font-semibold border-b-2">Scenes</button>
                    <button data-tab="stickers" class="vibe-tab flex-1 py-2 font-semibold border-b-2 border-transparent">Stickers</button>
                    <button data-tab="frames" class="vibe-tab flex-1 py-2 font-semibold border-b-2 border-transparent">Frames</button>
                </div>
                <div id="onme-scenes-panel" class="vibe-panel grid grid-cols-5 gap-2"></div>
                <div id="onme-stickers-panel" class="vibe-panel hidden grid grid-cols-6 gap-2"></div>
                <div id="onme-frames-panel" class="vibe-panel hidden grid grid-cols-5 gap-2"></div>
                <div class="text-center mt-6"><button id="onme-modal-download-button" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-700 text-lg shadow-lg">Download</button></div>
            </div>
        `;
        const modal = document.createElement('div');
        modal.id = 'onme-vibe-studio-modal';
        modal.innerHTML = modalHTML;
        document.body.appendChild(modal);
    }

    // --- 3. Widget Logic ---
    function initializeWidget() {
        const rootElement = document.getElementById(WIDGET_ROOT_ID);
        if (!rootElement) { return; }

        const tailwindScript = document.createElement('script');
        tailwindScript.src = "https://cdn.tailwindcss.com";
        document.head.appendChild(tailwindScript);
        
        const html2canvasScript = document.createElement('script');
        html2canvasScript.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
        document.head.appendChild(html2canvasScript);
        
        const supabaseScript = document.createElement('script');
        supabaseScript.src = "https://unpkg.com/@supabase/supabase-js@2";
        supabaseScript.onload = () => {
            if (supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
                dbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('OnMe Supabase client initialized.');
            }
        };
        document.head.appendChild(supabaseScript);

        rootElement.className = "onme-widget-container";
        
        injectCSS();
        createWidgetHTML(rootElement);

        // --- Element References ---
        const personUpload = document.getElementById('onme-person-upload');
        const personPreview = document.getElementById('onme-person-preview');
        const uploadLabel = document.getElementById('onme-upload-label');
        const generateButton = document.getElementById('onme-generate-button');
        const loadingSpinner = document.getElementById('onme-loading-spinner');
        const messageEl = document.getElementById('onme-message');
        const vibeStudioButton = document.getElementById('onme-vibe-studio-button');
        const modal = document.getElementById('onme-vibe-studio-modal');
        const closeModalButton = document.getElementById('onme-modal-close-button');
        const modalResultImage = document.getElementById('onme-modal-result-image');
        const modalResultContainer = document.getElementById('onme-modal-result-container');
        const stickerContainer = document.getElementById('onme-modal-sticker-container');
        const scenesPanel = document.getElementById('onme-scenes-panel');
        const stickersPanel = document.getElementById('onme-stickers-panel');
        const framesPanel = document.getElementById('onme-frames-panel');
        const downloadButton = document.getElementById('onme-modal-download-button');
        
        let personImageBase64 = null;

        // --- Utility Functions ---
        const fileToBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        const urlToBase64 = async (url) => {
            try {
                // Use a CORS proxy to prevent tainted canvas errors
                const proxyUrl = `https://cors-anywhere.herokuapp.com/${url}`;
                const response = await fetch(proxyUrl);
                const blob = await response.blob();
                return await fileToBase64(blob);
            } catch (error) {
                console.error("Image fetch error:", error);
                throw new Error("Could not fetch product image.");
            }
        };

        const updateUIState = (isLoading = false, message = '', resultImageUrl = null) => {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            generateButton.classList.toggle('hidden', isLoading);
            generateButton.disabled = isLoading;
            messageEl.textContent = message;
            if (resultImageUrl) {
                modalResultImage.src = resultImageUrl;
                vibeStudioButton.classList.remove('hidden');
            } else {
                vibeStudioButton.classList.add('hidden');
            }
        };

        // --- Event Handlers ---
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            personPreview.src = URL.createObjectURL(file);
            uploadLabel.textContent = 'Change Photo';
            generateButton.disabled = false;
            personImageBase64 = await fileToBase64(file);
            sessionStorage.setItem(SESSION_STORAGE_KEY, personImageBase64);
        }

        async function handleGeneration() {
            if (!personImageBase64) {
                updateUIState(false, 'Please upload your photo first.');
                return;
            }
            const productImageEl = document.getElementById(PRODUCT_IMAGE_ID);
            if (!productImageEl) {
                updateUIState(false, `Error: Product image with id #${PRODUCT_IMAGE_ID} not found.`);
                return;
            }

            updateUIState(true, 'Generating your try-on...');
            
            try {
                const clothingImageBase64 = await urlToBase64(productImageEl.src);
                const prompt = `Take the person from the first image and put the clothing item from the second image on them. The person should be wearing the clothes. Ensure the final generated image of the person has a transparent background (alpha channel), making it a clean cutout. The person's original background should be completely removed.`;
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/jpeg", data: personImageBase64 } },
                            { inlineData: { mimeType: "image/jpeg", data: clothingImageBase64 } }
                        ]
                    }],
                    generationConfig: { responseMimeType: 'application/json' },
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error (${response.status})`);
                
                const result = await response.json();
                const candidate = result?.candidates?.[0];
                const base64Data = candidate?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) throw new Error('No image data in API response.');
                
                const imageUrl = `data:image/png;base64,${base64Data}`;
                updateUIState(false, 'Generation complete!', imageUrl);
                
                // Log the successful event
                await logTryOnEvent();

            } catch (error) {
                console.error("API Error:", error);
                updateUIState(false, `Error: ${error.message}`);
            }
        }
        
        function handleStickerDrag(e) {
            const sticker = e.target;
            sticker.classList.add('dragging');
            let offsetX = e.clientX - sticker.getBoundingClientRect().left;
            let offsetY = e.clientY - sticker.getBoundingClientRect().top;

            function moveAt(pageX, pageY) {
                sticker.style.left = pageX - sticker.parentElement.getBoundingClientRect().left - offsetX + 'px';
                sticker.style.top = pageY - sticker.parentElement.getBoundingClientRect().top - offsetY + 'px';
            }

            function onMouseMove(event) {
                moveAt(event.pageX, event.pageY);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            
            sticker.onmouseup = function() {
                document.removeEventListener('mousemove', onMouseMove);
                sticker.onmouseup = null;
                sticker.classList.remove('dragging');
            };
            sticker.ondragstart = () => false;
        }

        // --- Initialization ---
        function loadSessionPhoto() {
            const savedPhoto = sessionStorage.getItem(SESSION_STORAGE_KEY);
            if (savedPhoto) {
                personImageBase64 = savedPhoto;
                personPreview.src = `data:image/jpeg;base64,${savedPhoto}`;
                uploadLabel.textContent = 'Change Photo';
                generateButton.disabled = false;
            }
        }

        function setupVibeStudio() {
            // Populate panels
            scenesPanel.innerHTML = SCENES.map(url => `<img src="${url}" class="w-full h-16 object-cover rounded cursor-pointer hover:opacity-75">`).join('');
            stickersPanel.innerHTML = STICKERS.map(url => `<img src="${url}" class="w-full h-12 object-contain p-1 rounded cursor-pointer hover:bg-gray-200">`).join('');
            framesPanel.innerHTML = ['None', 'Polaroid', 'Neon', 'Film'].map(name => `<div class="text-center p-2 border-2 rounded cursor-pointer hover:bg-gray-100">${name}</div>`).join('');
            
            // Event Listeners
            vibeStudioButton.onclick = () => modal.classList.add('flex');
            closeModalButton.onclick = () => modal.classList.remove('flex');
            modal.onclick = (e) => { if(e.target === modal) modal.classList.remove('flex'); };
            
            document.querySelectorAll('.vibe-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.vibe-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.vibe-panel').forEach(p => p.classList.add('hidden'));
                    tab.classList.add('active');
                    document.getElementById(`onme-${tab.dataset.tab}-panel`).classList.remove('hidden');
                };
            });
            
            scenesPanel.onclick = (e) => {
                if (e.target.tagName === 'IMG') modalResultContainer.style.backgroundImage = `url(${e.target.src})`;
            };
            
            stickersPanel.onclick = (e) => {
                if (e.target.tagName !== 'IMG') return;
                const sticker = document.createElement('img');
                sticker.src = e.target.src;
                sticker.className = 'onme-sticker';
                sticker.style.left = '50%';
                sticker.style.top = '50%';
                stickerContainer.appendChild(sticker);
                sticker.onmousedown = handleStickerDrag;
            };

            framesPanel.onclick = (e) => {
                modalResultContainer.className = modalResultContainer.className.replace(/onme-frame-\w+/g, '');
                const frameName = e.target.innerText.toLowerCase();
                if (frameName !== 'none') modalResultContainer.classList.add(`onme-frame-${frameName}`);
            };

            downloadButton.onclick = () => {
                html2canvas(modalResultContainer, { allowTaint: true, useCORS: true }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'onme-vibe.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            };
        }

        // --- Main Execution ---
        personUpload.addEventListener('change', handleFileUpload);
        generateButton.addEventListener('click', handleGeneration);
        loadSessionPhoto();
        setupVibeStudio();

        console.log(`OnMe Widget Initialized.`);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeWidget);
    } else {
        initializeWidget();
    }
})();
